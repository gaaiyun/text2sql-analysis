# Text2SQL Web应用使用指南

## 🚀 快速开始

### 1. 启动Web应用

```bash
# 进入项目目录
cd c:\Users\gaaiy\Desktop\text2sql

# 启动Web应用
python web_app.py
```

启动成功后，访问：**http://localhost:7860**

---

## 📱 界面说明

### 主界面布局

```
┌─────────────────────────────────────────────────────────┐
│  🚀 Text2SQL 智能查询系统                                │
├─────────────────────────────────────────────────────────┤
│  左侧：输入区                │  右侧：结果展示区          │
│  - 选择场景                  │  - 生成的SQL              │
│  - 输入问题                  │  - 数据预览               │
│  - 查询按钮                  │  - 图表分析               │
│  - 示例问题                  │  - 数据解读               │
│                              │  - 网络信息               │
│                              │  - 报告下载               │
└─────────────────────────────────────────────────────────┘
```

---

## 🎯 使用步骤

### 步骤1：选择场景

从下拉菜单选择您的业务场景：

- **场景1-数据洞察**：融资趋势、行业分布等数据分析
- **场景2-地区产业**：特定地区的产业发展分析
- **场景3-行业分析**：特定行业的发展趋势分析
- **场景4-招商清单**：企业筛选与评估
- **场景5-企业尽调**：单个企业的详细尽职调查

### 步骤2：输入问题

在文本框中输入您的自然语言问题，例如：

**场景1示例**：
```
分析2023-2024年融资趋势，按行业统计融资金额和融资数量
```

**场景2示例**：
```
分析广东省深圳市的产业分布，统计各行业企业数量和主要领域
```

**场景3示例**：
```
分析科技行业近5年的发展趋势，包括企业数量增长和地域分布
```

### 步骤3：点击查询

点击"🔍 查询"按钮，系统将自动：
1. 生成SQL查询语句
2. 执行数据库查询
3. 生成数据图表
4. 进行网络搜索补充
5. AI分析数据
6. 生成完整报告

**⏱️ 预计耗时**：1-2分钟（复杂查询可能更长）

### 步骤4：查看结果

在右侧的Tab页中查看不同类型的结果：

#### Tab 1: 生成的SQL
- 显示系统自动生成的SQL查询语句
- 可以复制用于其他用途

#### Tab 2: 数据预览
- 查询状态（成功/失败，记录数）
- 数据表格（前10条记录）
- Markdown格式，易于阅读

#### Tab 3: 图表分析
- 自动生成的数据可视化图表
- 根据数据类型自动选择图表类型（折线图/柱状图/饼图）

#### Tab 4: 数据解读
- AI对数据的深度分析
- 趋势解读、关键发现、业务洞察

#### Tab 5: 网络信息
- 相关的网络搜索结果
- 行业动态、最新资讯补充

#### Tab 6: 报告下载
- 完整的分析报告文件
- 支持3种格式：Markdown (.md)、PDF (.pdf)、Word (.docx)
- 点击文件名即可下载

---

## 📝 示例问题库

### 场景1：数据洞察

```
1. 分析2023-2024年融资趋势，按行业统计融资金额和融资数量
2. 查询近三年融资金额最高的10个行业
3. 统计2024年各轮次融资的数量和金额分布
4. 分析人工智能行业的融资趋势，按年份统计
5. 查询融资金额超过1亿元的融资事件，按时间排序
```

### 场景2：地区产业分析

```
1. 分析广东省深圳市的产业分布，统计各行业企业数量和主要领域
2. 查询北京市科技企业的数量和注册资本分布
3. 统计上海市各区的企业数量和主要行业
4. 分析杭州市互联网企业的发展情况
5. 查询成都市新能源企业的分布和规模
```

### 场景3：行业分析

```
1. 分析科技行业近5年的发展趋势，包括企业数量增长和地域分布
2. 查询人工智能行业的企业数量、注册资本和知识产权情况
3. 统计新能源行业的企业分布和融资情况
4. 分析医疗健康行业的企业规模和发展阶段
5. 查询金融科技行业的企业数量和地域分布
```

### 场景4：招商清单

```
1. 查询注册资本超过1000万的企业，统计其基本信息、知识产权和诉讼情况
2. 筛选科技行业中注册资本超过5000万且有专利的企业
3. 查询近3年成立的高新技术企业，统计其融资和知识产权情况
4. 筛选无诉讼记录且有投标经验的企业
5. 查询注册资本超过1亿元的制造业企业
```

### 场景5：企业尽调

```
1. 查询某一家企业的详细信息，生成全面尽职调查报告
2. 分析企业的注册资本、股东结构、经营范围和知识产权
3. 查询企业的诉讼记录、投标情况和纳税信息
4. 生成企业的综合评估报告，包括风险分析和发展建议
5. 查询企业的融资历史和投资方信息
```

---

## 🔧 技术架构

### 核心技术栈

| 组件 | 技术 | 说明 |
|------|------|------|
| Web框架 | Gradio 6.0 | 专业的AI应用Web界面框架 |
| SQL生成 | 阿里云百炼 Coding Plan | qwen3.5-plus模型 |
| 数据库 | MySQL 8.0 | 场景1-3: Gaaiyun, 场景4-5: gaaiyun_2 |
| 图表生成 | Matplotlib | 自动推断图表类型 |
| 网络搜索 | DuckDuckGo | 实时信息补充 |
| 报告生成 | ReportLab + python-docx | 多格式输出 |

### 系统流程

```
用户输入自然语言问题
    ↓
LLM生成SQL（基于Schema + Few-shot示例）
    ↓
执行SQL查询数据库
    ↓
图表自动推断与生成
    ↓
网络搜索补充信息
    ↓
LLM分析数据并生成解读
    ↓
多模态报告输出（MD/PDF/Word）
```

---

## ⚠️ 注意事项

### 性能相关

1. **查询时间**：
   - 简单查询：30秒-1分钟
   - 复杂查询：1-2分钟
   - 大数据量查询：2-3分钟

2. **并发限制**：
   - 建议单用户使用
   - 多用户需要增加资源配置

3. **数据量限制**：
   - 单次查询最多返回1000条记录
   - 图表显示最多100个数据点

### 使用建议

1. **问题描述**：
   - 尽量具体明确
   - 包含时间范围、统计维度等关键信息
   - 避免过于模糊的问题

2. **场景选择**：
   - 根据数据库选择正确的场景
   - 场景1-3使用Gaaiyun数据库
   - 场景4-5使用gaaiyun_2数据库

3. **结果验证**：
   - 查看生成的SQL是否符合预期
   - 检查数据记录数是否合理
   - 对比图表和数据是否一致

### 常见问题

**Q1: 查询失败怎么办？**
- 检查问题描述是否清晰
- 查看生成的SQL是否有语法错误
- 尝试简化问题重新查询

**Q2: 图表不显示？**
- 可能是数据量太少（<2条）
- 可能是数据类型不适合可视化
- 查看错误信息了解具体原因

**Q3: 报告下载失败？**
- 检查output目录是否存在
- 确认有足够的磁盘空间
- 查看系统日志了解错误

**Q4: 网络搜索无结果？**
- 可能是网络连接问题
- 可能是搜索关键词不够准确
- 不影响其他功能正常使用

---

## 🛠️ 高级配置

### 修改端口号

编辑 `web_app.py` 文件，修改第252行：

```python
app.launch(
    server_name="0.0.0.0",
    server_port=7860,  # 修改为其他端口
    share=False,
    show_error=True
)
```

### 启用公共访问

如需通过公网访问，修改：

```python
app.launch(
    server_name="0.0.0.0",
    server_port=7860,
    share=True,  # 改为True，会生成公共链接
    show_error=True
)
```

### 自定义主题

修改第128行：

```python
with gr.Blocks(title="Text2SQL 智能查询系统") as app:
    # 在launch()中添加theme参数
```

然后在launch()中添加：

```python
app.launch(
    server_name="0.0.0.0",
    server_port=7860,
    share=False,
    show_error=True,
    theme=gr.themes.Soft()  # 或 Base(), Monochrome()等
)
```

---

## 📊 输出文件说明

### 文件命名规则

```
output/web_scenario_X_YYYYMMDD_HHMMSS.{md|pdf|docx}
```

- `web_`: Web应用生成的文件前缀
- `scenario_X`: 场景编号（1-5）
- `YYYYMMDD_HHMMSS`: 生成时间戳
- 扩展名: `.md`（Markdown）、`.pdf`（PDF）、`.docx`（Word）

### 报告内容结构

所有报告包含以下章节：

1. **标题与生成时间**
2. **用户问题**
3. **生成的SQL**（代码块）
4. **数据概览**（表格或关键指标）
5. **数据图表**（嵌入图片）
6. **数据分析与解读**（AI生成）
7. **网络信息补充**（搜索结果）
8. **建议与结论**

---

## 🔒 安全说明

### 数据安全

- 所有查询仅在本地执行
- 不会上传数据到外部服务器
- 报告文件保存在本地output目录

### API密钥保护

- API密钥存储在.env文件中
- 不会在界面或日志中显示
- 不会包含在生成的报告中

### 访问控制

- 默认仅本地访问（localhost）
- 如需外部访问，需手动启用share=True
- 建议在内网环境使用

---

## 📞 技术支持

### 日志查看

查看系统日志了解详细错误信息：

```bash
# 查看Web应用日志
python web_app.py 2>&1 | tee web_app.log
```

### 问题反馈

如遇到问题，请提供：
1. 问题描述
2. 选择的场景
3. 输入的问题
4. 错误信息截图
5. 生成的SQL（如有）

---

## 🎉 开始使用

现在您可以：

1. 打开浏览器访问 http://localhost:7860
2. 选择一个场景
3. 输入您的问题
4. 点击查询按钮
5. 查看结果并下载报告

**祝您使用愉快！** 🚀

---

*Text2SQL v2.0 | Powered by Gradio + 阿里云百炼 | © 2026*
